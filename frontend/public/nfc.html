<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üè∑Ô∏è RFID/NFC Scanner - AdvirLink</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }

            .container {
                max-width: 400px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

            .header {
                text-align: center;
                margin-bottom: 20px;
            }

            .input-group {
                margin-bottom: 15px;
            }

            .input-group label {
                display: block;
                font-weight: bold;
                margin-bottom: 5px;
            }

            .input-group input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 16px;
            }

            .scan-button {
                width: 100%;
                padding: 15px;
                background: #4caf50;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
            }

            .scan-button:hover {
                background: #45a049;
                transform: translateY(-2px);
            }

            .scan-button:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }

            .stop-button {
                background: #f44336;
            }

            .stop-button:hover {
                background: #d32f2f;
            }

            .status {
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
                text-align: center;
                font-weight: bold;
            }

            .status.success {
                background: #d4edda;
                color: #155724;
            }

            .status.error {
                background: #f8d7da;
                color: #721c24;
            }

            .status.info {
                background: #d1ecf1;
                color: #0c5460;
            }

            .scanning-animation {
                text-align: center;
                padding: 30px;
                background: #e3f2fd;
                border-radius: 10px;
                border: 3px dashed #2196f3;
                margin: 20px 0;
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.05);
                }
            }

            .instructions {
                font-size: 14px;
                color: #666;
                margin-top: 20px;
                line-height: 1.5;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h2>üè∑Ô∏è Scanner RFID/NFC</h2>
                <p>AdvirLink - Interven√ß√µes</p>
            </div>

            <div class="input-group">
                <label for="phoneNumber">üìû N√∫mero WhatsApp:</label>
                <input
                    type="text"
                    id="phoneNumber"
                    placeholder="Ex: 351912345678"
                />
            </div>

            <button id="scanButton" class="scan-button">
                üì° Iniciar Scanner NFC
            </button>

            <div id="scanningArea" style="display: none">
                <div class="scanning-animation">
                    <div style="font-size: 48px">üì±</div>
                    <p><strong>Aproxime o cart√£o RFID/NFC</strong></p>
                </div>
            </div>

            <div id="status"></div>

            <div class="instructions">
                <h4>üìã Instru√ß√µes - Scanner de Artigos:</h4>
                <ol>
                    <li>O n√∫mero WhatsApp j√° deve estar preenchido</li>
                    <li>Toque em "Iniciar Scanner NFC"</li>
                    <li>Aproxime o cart√£o RFID do telem√≥vel</li>
                    <li>O c√≥digo ser√° enviado automaticamente para o WhatsApp</li>
                    <li>Volte para o WhatsApp para continuar a conversa</li>
                    <li>Repita para adicionar mais artigos</li>
                </ol>

                <p><strong>üí° Dica:</strong> Este scanner integra-se com o sistema de interven√ß√µes via WhatsApp. Depois de escanear, continue a conversa no WhatsApp.</p>

                <p><strong>‚ö†Ô∏è Requisitos:</strong></p>
                <ul>
                    <li>Android com NFC ativado</li>
                    <li>Chrome browser</li>
                    <li>Conex√£o √† internet</li>
                    <li>Conversa ativa no WhatsApp</li>
                </ul>
            </div>
        </div>

        <script>
            let isScanning = false;
            let ndefReader = null;

            const scanButton = document.getElementById("scanButton");
            const phoneNumberInput = document.getElementById("phoneNumber");
            const scanningArea = document.getElementById("scanningArea");
            const statusDiv = document.getElementById("status");

            // Verificar suporte NFC
            if (!("NDEFReader" in window)) {
                showStatus("‚ùå NFC n√£o suportado neste browser", "error");
                scanButton.disabled = true;
                scanButton.textContent = "NFC N√£o Suportado";
            } else {
                showStatus("‚úÖ NFC suportado - Pronto para usar", "success");
            }

            // Auto-preencher n√∫mero de telefone se fornecido via URL
            const urlParams = new URLSearchParams(window.location.search);
            const phoneFromUrl = urlParams.get('phone');
            if (phoneFromUrl) {
                phoneNumberInput.value = phoneFromUrl;
                showStatus("üìû N√∫mero WhatsApp carregado automaticamente", "success");
                
                // Auto-iniciar o scanner se o n√∫mero j√° estiver preenchido
                setTimeout(() => {
                    if (phoneNumberInput.value.trim()) {
                        startScanning();
                    }
                }, 1000);
            }

            scanButton.addEventListener("click", toggleScanning);

            async function toggleScanning() {
                if (!isScanning) {
                    startScanning();
                } else {
                    stopScanning();
                }
            }

            async function startScanning() {
                const phoneNumber = phoneNumberInput.value.trim();
                if (!phoneNumber) {
                    showStatus(
                        "‚ùå Por favor, insira o n√∫mero de telefone",
                        "error",
                    );
                    return;
                }

                try {
                    isScanning = true;
                    scanButton.textContent = "‚èπÔ∏è Parar Scanner";
                    scanButton.className = "scan-button stop-button";
                    scanningArea.style.display = "block";
                    showStatus("üì° A aguardar aproxima√ß√£o do RFID...", "info");

                    ndefReader = new NDEFReader();
                    await ndefReader.scan();

                    ndefReader.addEventListener("reading", handleNFCRead);
                } catch (error) {
                    console.error("Erro NFC:", error);
                    showStatus(
                        `‚ùå Erro ao iniciar NFC: ${error.message}`,
                        "error",
                    );
                    stopScanning();
                }
            }

            function stopScanning() {
                isScanning = false;
                scanButton.textContent = "üì° Iniciar Scanner NFC";
                scanButton.className = "scan-button";
                scanningArea.style.display = "none";

                if (ndefReader) {
                    // Note: n√£o h√° m√©todo oficial para parar, mas removemos o listener
                    ndefReader = null;
                }

                showStatus("‚èπÔ∏è Scanner parado", "info");
            }

            function handleNFCRead(event) {
                const { message, serialNumber } = event;
                const rfidCode = serialNumber || `RFID_${Date.now()}`;

                showStatus(`‚úÖ RFID lido: ${rfidCode}`, "success");

                // Vibra√ß√£o
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }

                // Enviar para WhatsApp
                sendToWhatsApp(rfidCode);

                // Parar scanning ap√≥s leitura
                stopScanning();
            }

            async function sendToWhatsApp(rfidCode) {
                const phoneNumber = phoneNumberInput.value.trim();

                try {
                    showStatus("üì§ Enviando para WhatsApp...", "info");

                    // Usar a API correta do backend WhatsApp
                    const response = await fetch("/api/whatsapp/send", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            to: phoneNumber,
                            message: rfidCode,
                            priority: "high",
                        }),
                    });

                    if (response.ok) {
                        showStatus(
                            `‚úÖ RFID ${rfidCode} enviado com sucesso!\n\n` +
                            `üîÑ Volte para o WhatsApp para continuar a conversa`,
                            "success",
                        );

                        // Vibra√ß√£o de sucesso
                        if (navigator.vibrate) {
                            navigator.vibrate([200, 100, 200, 100, 200]);
                        }

                        // Mostrar bot√£o para continuar no WhatsApp
                        setTimeout(() => {
                            showStatus(
                                `‚úÖ C√≥digo enviado: ${rfidCode}\n\n` +
                                `üì± Continue no WhatsApp para adicionar mais artigos ou finalizar`,
                                "success",
                            );
                        }, 2000);

                        // Auto-reiniciar scanner para pr√≥ximo artigo
                        setTimeout(() => {
                            if (confirm("Deseja escanear outro artigo?")) {
                                startScanning();
                            }
                        }, 3000);
                    } else {
                        showStatus("‚ùå Erro ao enviar para WhatsApp", "error");
                    }
                } catch (error) {
                    showStatus("‚ùå Erro de conex√£o: " + error.message, "error");
                }
            }

            function showStatus(message, type) {
                statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        </script>
    </body>
</html>
